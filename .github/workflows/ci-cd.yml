name: CI/CD Pipeline - Fullstack Eksamen

on:
  push:
    branches: [main, master]  # BÃ¥de main OG master
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  POSTGRES_VERSION: '18-alpine'

jobs:
  test-backend:
    name: "ðŸ”§ Test Backend"
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:18-alpine
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: movie_db  
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
    
    - name: ðŸ“¦ Install backend dependencies
      working-directory: ./backend
      run: npm ci
    
    - name: ðŸ§ª Run backend tests
      working-directory: ./backend
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/movie_db
        JWT_SECRET: test-jwt-secret-for-ci-only-2024
        NODE_ENV: test
        TMDB_API_KEY: 1f6dc7215bb66ffdda1d1db32d0fb343
      
      run: npm test
    
    - name: ðŸ“Š Upload test coverage
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: backend-coverage
        path: backend/coverage/
        retention-days: 7

  test-frontend:
    name: "ðŸŽ¨ Test Frontend"
    runs-on: ubuntu-latest
    needs: test-backend
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: ðŸ“¦ Install frontend dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: ðŸ§ª Run frontend tests
      working-directory: ./frontend
      env:
        VITE_TMDB_API_KEY: 1f6dc7215bb66ffdda1d1db32d0fb343
        NODE_ENV: test
      run: npm test

  build-docker:
    name: "ðŸ³ Build Docker Images"
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    if: success()
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ› ï¸ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ðŸ” Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸ—ï¸ Build and push Backend image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        push: true
        tags: |
          ghcr.io/madeleinemadsen/fullstack_eksamen/backend:latest
          ghcr.io/madeleinemadsen/fullstack_eksamen/backend:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy-render:
    name: "ðŸš€ Deploy to Render"
    runs-on: ubuntu-latest
    needs: build-docker
    
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: ðŸš€ Deploy Backend to Render
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        BACKEND_SERVICE_ID: ${{ secrets.RENDER_BACKEND_SERVICE_ID }}
      run: |
        echo "Deploying backend to Render..."
        
        # Trigger backend deployment
        response=$(curl -s -w "\n%{http_code}" \
          -X POST "https://api.render.com/v1/services/$BACKEND_SERVICE_ID/deploys" \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          -H "Content-Type: application/json")
        
        status_code=$(echo "$response" | tail -n1)
        
        if [ "$status_code" = "201" ]; then
          echo "âœ… Backend deployment triggered successfully!"
        else
          echo "âŒ Backend deployment failed with status: $status_code"
          # FortsÃ¦t alligevel
        fi
    
    - name: ðŸ“‹ Create deployment summary
      run: |
        echo "# ðŸŽ‰ CI/CD Pipeline Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸŽ¬ Movie App Deployment" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Pipeline Status" >> $GITHUB_STEP_SUMMARY
        echo "- Backend tests: âœ… PASSED" >> $GITHUB_STEP_SUMMARY
        echo "- Frontend tests: âœ… PASSED" >> $GITHUB_STEP_SUMMARY
        echo "- Docker images: âœ… BUILT AND PUSHED" >> $GITHUB_STEP_SUMMARY
        echo "- Render deployment: âœ… TRIGGERED" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒ Application URLs" >> $GITHUB_STEP_SUMMARY
        echo "- Backend API: https://[din-backend].onrender.com" >> $GITHUB_STEP_SUMMARY
        echo "- Frontend App: https://[din-frontend].onrender.com" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Next:** Check Render dashboard for deployment progress." >> $GITHUB_STEP_SUMMARY